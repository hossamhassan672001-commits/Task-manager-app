<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Harbor</title>
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/quasar@2.16.6/dist/quasar.prod.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --ink: #1f1c2e;
        --muted: #6a6a79;
        --surface: #ffffff;
        --accent: #ff7a59;
        --accent-2: #23a59a;
        --bg: linear-gradient(135deg, #f4f1ed 0%, #f7e8df 35%, #efe4f7 100%);
      }

      body {
        font-family: "DM Sans", sans-serif;
        background: var(--bg);
        color: var(--ink);
        min-height: 100vh;
      }

      .app-title {
        font-family: "Space Grotesk", sans-serif;
        letter-spacing: -0.02em;
      }

      .app-shell {
        max-width: 1040px;
        margin: 0 auto;
        padding: 24px 16px 64px;
      }

      .hero {
        display: grid;
        gap: 16px;
        align-items: center;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        margin-bottom: 24px;
      }

      .hero-panel {
        background: var(--surface);
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 24px 48px rgba(31, 28, 46, 0.08);
      }

      .hero-panel h1 {
        margin: 0 0 8px;
        font-size: 2rem;
      }

      .hero-panel p {
        margin: 0;
        color: var(--muted);
      }

      .stat-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        margin-top: 16px;
      }

      .stat-card {
        border-radius: 18px;
        padding: 16px;
        background: #fdf9f5;
        border: 1px solid rgba(31, 28, 46, 0.08);
      }

      .stat-card strong {
        font-size: 1.6rem;
      }

      .task-card {
        border-radius: 18px;
        border: 1px solid rgba(31, 28, 46, 0.08);
        background: var(--surface);
      }

      .task-meta {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        background: rgba(35, 165, 154, 0.12);
        color: var(--accent-2);
      }

      .badge.open {
        background: rgba(255, 122, 89, 0.12);
        color: var(--accent);
      }

      .list-shell {
        display: grid;
        gap: 16px;
      }

      .empty-state {
        text-align: center;
        padding: 32px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <q-layout view="lHh Lpr lFf">
        <q-page-container>
          <q-page class="app-shell">
            <div class="hero">
              <div class="hero-panel">
                <h1 class="app-title">Task Harbor</h1>
                <p>Track work with a calm, focused task board.</p>
                <div class="stat-grid">
                  <div class="stat-card">
                    <div class="task-meta">Open</div>
                    <strong>{{ stats.open }}</strong>
                  </div>
                  <div class="stat-card">
                    <div class="task-meta">In progress</div>
                    <strong>{{ stats.in_progress }}</strong>
                  </div>
                  <div class="stat-card">
                    <div class="task-meta">Done</div>
                    <strong>{{ stats.done }}</strong>
                  </div>
                </div>
              </div>
              <div class="hero-panel">
                <div class="text-h6 app-title">Add new task</div>
                <q-form @submit.prevent="createTask" class="q-gutter-md q-mt-md">
                  <q-input
                    filled
                    v-model="form.title"
                    label="Task title"
                    :disable="submitting"
                    maxlength="120"
                    lazy-rules
                    :rules="[(val) => !!val || 'Title is required']"
                  />
                  <q-input
                    filled
                    v-model="form.description"
                    label="What needs to happen?"
                    type="textarea"
                    :disable="submitting"
                    maxlength="480"
                  />
                  <q-select
                    filled
                    v-model="form.status"
                    :options="statusOptions"
                    label="Status"
                    :disable="submitting"
                  />
                  <q-btn
                    type="submit"
                    color="deep-orange-5"
                    text-color="white"
                    label="Create task"
                    :loading="submitting"
                    class="full-width"
                  />
                </q-form>
              </div>
            </div>

            <q-banner v-if="error" class="bg-red-2 text-red-9 q-mb-md" rounded>
              {{ error }}
            </q-banner>

            <div class="list-shell">
              <q-card class="task-card" v-if="loading">
                <q-card-section>
                  <div class="row items-center">
                    <q-spinner size="24px" color="deep-orange-5" />
                    <span class="q-ml-sm">Loading tasks...</span>
                  </div>
                </q-card-section>
              </q-card>

              <div v-if="!loading && tasks.length === 0" class="empty-state">
                No tasks yet. Add your first task to get started.
              </div>

              <q-card v-for="task in tasks" :key="task.id" class="task-card">
                <q-card-section>
                  <div class="row items-start justify-between">
                    <div>
                      <div class="text-h6">{{ task.title }}</div>
                      <div class="task-meta q-mt-xs">{{ task.description || 'No description' }}</div>
                    </div>
                    <span class="badge" :class="task.status">
                      <q-icon name="task_alt" size="18px" />
                      {{ labelFor(task.status) }}
                    </span>
                  </div>
                </q-card-section>
                <q-separator />
                <q-card-actions align="right">
                  <q-btn flat color="primary" label="Edit" @click="openEdit(task)" />
                  <q-btn flat color="negative" label="Delete" @click="deleteTask(task.id)" />
                </q-card-actions>
              </q-card>
            </div>
          </q-page>
        </q-page-container>
      </q-layout>

      <q-dialog v-model="editDialog">
        <q-card style="min-width: 320px;">
          <q-card-section>
            <div class="text-h6 app-title">Update task</div>
          </q-card-section>
          <q-card-section class="q-pt-none">
            <q-form @submit.prevent="saveEdit" class="q-gutter-md">
              <q-input
                filled
                v-model="editForm.title"
                label="Task title"
                maxlength="120"
                :rules="[(val) => !!val || 'Title is required']"
              />
              <q-input
                filled
                v-model="editForm.description"
                label="Description"
                type="textarea"
                maxlength="480"
              />
              <q-select
                filled
                v-model="editForm.status"
                :options="statusOptions"
                label="Status"
              />
              <div class="row justify-end q-gutter-sm">
                <q-btn flat label="Cancel" v-close-popup />
                <q-btn
                  color="deep-orange-5"
                  text-color="white"
                  label="Save"
                  type="submit"
                  :loading="savingEdit"
                />
              </div>
            </q-form>
          </q-card-section>
        </q-card>
      </q-dialog>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.16.6/dist/quasar.umd.prod.js"></script>
    <script>
      const { createApp, ref, reactive, computed, onMounted } = Vue;
      const { Quasar } = window;

      createApp({
        setup() {
          const apiBase = "http://localhost:4000/api";
          const tasks = ref([]);
          const loading = ref(true);
          const submitting = ref(false);
          const savingEdit = ref(false);
          const error = ref("");
          const editDialog = ref(false);
          const statusOptions = [
            { label: "Open", value: "open" },
            { label: "In progress", value: "in_progress" },
            { label: "Done", value: "done" }
          ];

          const form = reactive({
            title: "",
            description: "",
            status: "open"
          });

          const editForm = reactive({
            id: null,
            title: "",
            description: "",
            status: "open"
          });

          const stats = computed(() => {
            const totals = { open: 0, in_progress: 0, done: 0 };
            tasks.value.forEach((task) => {
              if (totals[task.status] !== undefined) {
                totals[task.status] += 1;
              }
            });
            return totals;
          });

          const labelFor = (status) => {
            const match = statusOptions.find((option) => option.value === status);
            return match ? match.label : "Open";
          };

          const handleError = (message) => {
            error.value = message;
            setTimeout(() => {
              error.value = "";
            }, 4000);
          };

          const fetchTasks = async () => {
            loading.value = true;
            try {
              const response = await fetch(`${apiBase}/tasks`);
              if (!response.ok) {
                throw new Error("Failed to load tasks");
              }
              const data = await response.json();
              tasks.value = data.tasks || [];
            } catch (err) {
              handleError(err.message || "Failed to load tasks");
            } finally {
              loading.value = false;
            }
          };

          const createTask = async () => {
            submitting.value = true;
            try {
              const response = await fetch(`${apiBase}/tasks`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  title: form.title,
                  description: form.description,
                  status: form.status
                })
              });
              if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || "Failed to create task");
              }
              form.title = "";
              form.description = "";
              form.status = "open";
              await fetchTasks();
            } catch (err) {
              handleError(err.message || "Failed to create task");
            } finally {
              submitting.value = false;
            }
          };

          const openEdit = (task) => {
            editForm.id = task.id;
            editForm.title = task.title;
            editForm.description = task.description;
            editForm.status = task.status;
            editDialog.value = true;
          };

          const saveEdit = async () => {
            savingEdit.value = true;
            try {
              const response = await fetch(`${apiBase}/tasks/${editForm.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  title: editForm.title,
                  description: editForm.description,
                  status: editForm.status
                })
              });
              if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || "Failed to update task");
              }
              editDialog.value = false;
              await fetchTasks();
            } catch (err) {
              handleError(err.message || "Failed to update task");
            } finally {
              savingEdit.value = false;
            }
          };

          const deleteTask = async (id) => {
            if (!confirm("Delete this task?")) {
              return;
            }
            try {
              const response = await fetch(`${apiBase}/tasks/${id}`, {
                method: "DELETE"
              });
              if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || "Failed to delete task");
              }
              await fetchTasks();
            } catch (err) {
              handleError(err.message || "Failed to delete task");
            }
          };

          onMounted(fetchTasks);

          return {
            tasks,
            loading,
            submitting,
            savingEdit,
            error,
            form,
            editForm,
            statusOptions,
            stats,
            labelFor,
            createTask,
            openEdit,
            saveEdit,
            deleteTask,
            editDialog
          };
        }
      })
        .use(Quasar, { config: {} })
        .mount("#app");
    </script>
  </body>
</html>
